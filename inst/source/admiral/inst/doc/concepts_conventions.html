<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Programming Concepts and Conventions</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Programming Concepts and Conventions</h1>



<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This vignette aims to discuss some of the common programming concepts
and conventions that have been adopted within the <code>{admiral}</code>
family of packages. It is intended to be a user-facing version of the <a href="https://pharmaverse.github.io/admiraldev/articles/programming_strategy.html">Programming
Strategy</a> vignette, but users can also read the latter after becoming
more familiar with the package to expand further on any topics of
interest. For some of common <code>{admiral}</code> FAQ, visit the
corresponding FAQ page provided in the same drop down menu as this
vignette.</p>
</div>
<div id="input-and-output" class="section level1">
<h1>Input and Output</h1>
<p>It is expected that the input dataset is not grouped. Otherwise an
error is issued.</p>
<p>The output dataset is ungrouped. The observations are not ordered in
a dedicated way. In particular, the order of the observations of the
input dataset may not be preserved.</p>
</div>
<div id="admiral-functions-and-options" class="section level1">
<h1><code>{admiral}</code> Functions and Options</h1>
<p>As a general principle, the behavior of the <code>{admiral}</code>
functions is only determined by their input, not by any global object,
i.e. all inputs like datasets, variable names, options, etc. must be
provided to the function by arguments. Correspondingly, in general
functions do not have any side-effects like creating or modifying global
objects, printing, writing files, etc.</p>
<p>An exception to the above principle is found in our approach to
package options (see <code>get_admiral_option()</code> and
<code>set_admiral_options()</code>), which allow for user-defined
defaults on commonly used function arguments. For instance, the option
<code>subject_keys</code> is currently pre-defined as
<code>exprs(STUDYID, USUBJID)</code>, but can be modified using
<code>set_admiral_options(subject_keys = exprs(...))</code> at the top
of a script.</p>
<p>For a full discussion on admiral Inputs, Outputs and Options, see <a href="https://pharmaverse.github.io/admiraldev/articles/programming_strategy.html#input-output-and-side-effects">this
section</a> on our developer-facing Programming Strategy.</p>
</div>
<div id="missing" class="section level1">
<h1>Handling of Missing Values</h1>
<p>When using the <code>{haven}</code> package to read SAS datasets into
R, SAS-style character missing values, i.e. <code>&quot;&quot;</code>, are
<em>not</em> converted into proper R <code>NA</code> values. Rather they
are kept as is. This is problematic for any downstream data processing
as R handles <code>&quot;&quot;</code> just as any other string. Thus, before any
data manipulation is being performed SAS blanks should be converted to R
<code>NA</code>s using <code>{admiral}</code>’s
<code>convert_blanks_to_na()</code> function, e.g.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>dm <span class="ot">&lt;-</span> haven<span class="sc">::</span><span class="fu">read_sas</span>(<span class="st">&quot;dm.sas7bdat&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  <span class="fu">convert_blanks_to_na</span>()</span></code></pre></div>
<p>Note that any logical operator being applied to an <code>NA</code>
value <em>always</em> returns <code>NA</code> rather than
<code>TRUE</code> or <code>FALSE</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>visits <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Baseline&quot;</span>, <span class="cn">NA</span>, <span class="st">&quot;Screening&quot;</span>, <span class="st">&quot;Week 1 Day 7&quot;</span>)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>visits <span class="sc">!=</span> <span class="st">&quot;Baseline&quot;</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="co">#&gt; [1] FALSE    NA  TRUE  TRUE</span></span></code></pre></div>
<p>The only exception is <code>is.na()</code> which returns
<code>TRUE</code> if the input is <code>NA</code>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">is.na</span>(visits)</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="co">#&gt; [1] FALSE  TRUE FALSE FALSE</span></span></code></pre></div>
<p>Thus, to filter all visits which are not <code>&quot;Baseline&quot;</code> the
following condition would need to be used.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>visits <span class="sc">!=</span> <span class="st">&quot;Baseline&quot;</span> <span class="sc">|</span> <span class="fu">is.na</span>(visits)</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="co">#&gt; [1] FALSE  TRUE  TRUE  TRUE</span></span></code></pre></div>
<p>Also note that most aggregation functions, like <code>mean()</code>
or <code>max()</code>, also return <code>NA</code> if any element of the
input vector is missing.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="cn">NA</span>, <span class="dv">2</span>))</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="co">#&gt; [1] NA</span></span></code></pre></div>
<p>To avoid this behavior one has to explicitly set
<code>na.rm = TRUE</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="cn">NA</span>, <span class="dv">2</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="co">#&gt; [1] 1.5</span></span></code></pre></div>
<p>This is very important to keep in mind when using
<code>{admiral}</code>’s aggregation functions such as
<code>derive_summary_records()</code>.</p>
<p>For handling of <code>NA</code>s in sorting variables see <a href="generic.html#sort_order">Sort Order</a>.</p>
</div>
<div id="exprs" class="section level1">
<h1>Expressions in Scripts</h1>
<div id="quoting-and-unquoting-introducing-expr-exprs-and" class="section level2">
<h2>Quoting and Unquoting: Introducing <code>expr()</code>,
<code>exprs()</code>, <code>!!</code> and <code>!!!</code></h2>
<div id="expr-and-exprs" class="section level3">
<h3><code>expr()</code> and <code>exprs()</code></h3>
<p><code>expr()</code> is a function from the <code>{rlang}</code>
package, which is used to create an <strong>expression</strong>. The
expression is not evaluated - rather, it is passed on to the derivation
function which evaluates it in its own environment. <code>exprs()</code>
is the plural version of <code>expr()</code>, so it accepts multiple
comma-separated items and returns a list of expressions.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">library</span>(rlang)</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>adae <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">USUBJID =</span> <span class="st">&quot;XXX-1&quot;</span>, <span class="at">AEDECOD =</span> <span class="st">&quot;HEADACHE&quot;</span>)</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="co"># Return the adae object</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>adae</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="co">#&gt;   USUBJID  AEDECOD</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="co">#&gt; 1   XXX-1 HEADACHE</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="co"># Return an expression</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="fu">expr</span>(adae)</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a><span class="co">#&gt; adae</span></span></code></pre></div>
<p>When used within the contest of an <code>{admiral}</code> derivation
function, <code>expr()</code> and <code>exprs()</code> allow the
function to evaluate the expressions in the context of the input
dataset. As an example, <code>expr()</code> and <code>exprs()</code>
allow users to pass variable names of datasets to the function without
wrapping them in quotation marks.</p>
<p>The expressions framework is powerful because users are able to
intuitively “inject code” into <code>admiral</code> functions (through
the function parameters) using very similar syntax as if they were
writing open code, with the exception possibly being an outer
<code>exprs()</code> wrapper. For instance, in the
<code>derive_vars_merged()</code> call below, the user is merging
<code>adsl</code> with <code>ex</code> and is able to filter
<code>ex</code> prior to the merge using an expression passed to the
<code>filter_add</code> parameter. Because <code>filter_add</code>
accepts expressions, the user has full power to filter their dataset as
they please. In the same vein, the user is able to create any new
variables they wish after the merge using the <code>new_vars</code>
argument, to which they pass a list of expressions containing “standard”
R code.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">derive_vars_merged</span>(</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  adsl,</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>  <span class="at">dataset_add =</span> ex,</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>  <span class="at">filter_add =</span> <span class="sc">!</span><span class="fu">is.na</span>(EXENDTM),</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>  <span class="at">by_vars =</span> <span class="fu">exprs</span>(STUDYID, USUBJID),</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>  <span class="at">new_vars =</span> <span class="fu">exprs</span>(</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>    <span class="at">TRTEDTM =</span> EXENDTM,</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>    <span class="at">TRTETMF =</span> EXENTMF,</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>    <span class="at">COMPTRT =</span> <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.na</span>(EXENDTM), <span class="st">&quot;Y&quot;</span>, <span class="st">&quot;N&quot;</span>)</span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>  ),</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>  <span class="at">order =</span> <span class="fu">exprs</span>(EXENDTM),</span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>  <span class="at">mode =</span> <span class="st">&quot;last&quot;</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="unquoting" class="section level3">
<h3>Bang-Bang (<code>!!</code>) and Bang-Bang-Bang
(<code>!!!</code>)</h3>
<p>Sometimes you may want to construct an expression using other,
pre-existing expressions. However, it’s not immediately clear how to
achieve this because expressions inherently pause evaluation of your
code before it’s executed:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">expr</span>(<span class="dv">2</span>)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">expr</span>(<span class="dv">3</span>)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="fu">expr</span>(a <span class="sc">+</span> b)</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="co">#&gt; a + b</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="co"># NOT 2 + 3</span></span></code></pre></div>
<p>This is where <code>!!</code> (bang-bang) comes in: provided again by
the <code>{rlang}</code> package, it allows you to inject the contents
of an expression into another expression, meaning that by using
<code>!!</code> you can modify the code inside an expression before R
evaluates it. By using <code>!!</code> you are
<strong>unquoting</strong> an expression, i.e. evaluating it before you
pass it onwards.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">expr</span>(<span class="sc">!!</span>a <span class="sc">+</span> <span class="sc">!!</span>b)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="co">#&gt; 2 + 3</span></span></code></pre></div>
<p>You can see an example of where <code>!!</code> comes in handy within
<code>{admiral}</code> code in <a href="#pitfall1">Common Pitfall 1</a>,
where the contents of an expression is unquoted so that it can be passed
to <code>derive_vars_merged()</code>.</p>
<p><code>!!!</code> (bang-bang-bang) is the plural version of
<code>!!</code> and can be used to unquote a list of expressions:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">exprs</span>(<span class="sc">!!!</span><span class="fu">list</span>(a, b))</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="co">#&gt; [[1]]</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="co">#&gt; [1] 2</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="co">#&gt; [[2]]</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="co">#&gt; [1] 3</span></span></code></pre></div>
<p>Within <code>{admiral}</code>, this operator can be useful if we need
to unquote a list of variables (stored as expressions) to use them
inside of an <code>{admiral}</code> or even <code>{dplyr}</code> call.
One example is the <code>{admiral}</code> subject keys:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">get_admiral_option</span>(<span class="st">&quot;subject_keys&quot;</span>)</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="co">#&gt; [[1]]</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="co">#&gt; STUDYID</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="co">#&gt; [[2]]</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="co">#&gt; USUBJID</span></span></code></pre></div>
<p>If we want to use the subject keys stored within this
<code>{admiral}</code> option to subset a dataset, we need to use
<code>!!!</code> to unquote this list. Let’s construct a dummy example
to illustrate the point:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>adcm <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">STUDYID =</span> <span class="st">&quot;XXX&quot;</span>, <span class="at">USUBJID =</span> <span class="st">&quot;XXX-1&quot;</span>, <span class="at">CMTRT =</span> <span class="st">&quot;ASPIRIN&quot;</span>)</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>adcm</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="co">#&gt;   STUDYID USUBJID   CMTRT</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="co">#&gt; 1     XXX   XXX-1 ASPIRIN</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="co"># This doesn&#39;t work as we are not unquoting the subject keys</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>adcm <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">get_admiral_option</span>(<span class="st">&quot;subject_keys&quot;</span>))</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a><span class="co">#&gt; Error in `select()`:</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a><span class="co">#&gt; ! Can&#39;t select columns with `get_admiral_option(&quot;subject_keys&quot;)`.</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a><span class="co">#&gt; ✖ `get_admiral_option(&quot;subject_keys&quot;)` must be numeric or character, not a list.</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a><span class="co"># This works because we are unquoting the subject keys</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>adcm <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">!!!</span><span class="fu">get_admiral_option</span>(<span class="st">&quot;subject_keys&quot;</span>))</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a><span class="co">#&gt;   STUDYID USUBJID</span></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a><span class="co">#&gt; 1     XXX   XXX-1</span></span></code></pre></div>
<p>You can see another example of <code>!!!</code> in action in <a href="https://github.com/pharmaverse/admiral/blob/c5dd8fb196c2cd3f27a6b02ec88fa1abd6b24d60/inst/templates/ad_adex.R#L162">this
line</a> of the <code>{admiral}</code> <code>ADEX</code> template
script, where it is used to dynamically control the by variables passed
to an <code>{admiral}</code> function.</p>
</div>
<div id="summary" class="section level3">
<h3>Summary</h3>
<p>In summary, although the expressions framework may seem slightly
clunky and mysterious to begin with, it allows for such power and
flexibility that it forms a key part of the <code>{admiral}</code>
package. For a comprehensive treatment of expressions, see <a href="https://adv-r.hadley.nz/expressions.html">Chapter 18</a> and <a href="https://adv-r.hadley.nz/quasiquotation.html">Chapter 19</a> of the
Advanced R textbook. Chapter 19 specifically covers in much more detail
the concept of unquoting.</p>
</div>
</div>
<div id="common-pitfalls" class="section level2">
<h2>Common pitfalls</h2>
<p>Expressions are very powerful, but this can also lead to
misunderstandings about their functionality. Let’s set up some dummy
data to explore common issues that new (or experienced!) programmers may
encounter when dealing with expressions.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="fu">library</span>(dplyr, <span class="at">warn.conflicts =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="fu">library</span>(admiral)</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>vs <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>  <span class="sc">~</span>USUBJID, <span class="sc">~</span>VSTESTCD, <span class="sc">~</span>VISIT, <span class="sc">~</span>VSSTRESN, <span class="sc">~</span>VSSTRESU, <span class="sc">~</span>VSDTC,</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>  <span class="st">&quot;01-1301&quot;</span>, <span class="st">&quot;WEIGHT&quot;</span>, <span class="st">&quot;SCREENING&quot;</span>, <span class="fl">82.1</span>, <span class="st">&quot;kg&quot;</span>, <span class="st">&quot;2013-08-29&quot;</span>,</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>  <span class="st">&quot;01-1301&quot;</span>, <span class="st">&quot;WEIGHT&quot;</span>, <span class="st">&quot;WEEK 2&quot;</span>, <span class="fl">81.19</span>, <span class="st">&quot;kg&quot;</span>, <span class="st">&quot;2013-09-15&quot;</span>,</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>  <span class="st">&quot;01-1301&quot;</span>, <span class="st">&quot;WEIGHT&quot;</span>, <span class="st">&quot;WEEK 4&quot;</span>, <span class="fl">82.56</span>, <span class="st">&quot;kg&quot;</span>, <span class="st">&quot;2013-09-24&quot;</span>,</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>  <span class="st">&quot;01-1302&quot;</span>, <span class="st">&quot;BMI&quot;</span>, <span class="st">&quot;SCREENING&quot;</span>, <span class="fl">20.1</span>, <span class="st">&quot;kg/m2&quot;</span>, <span class="st">&quot;2013-08-29&quot;</span>,</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>  <span class="st">&quot;01-1302&quot;</span>, <span class="st">&quot;BMI&quot;</span>, <span class="st">&quot;WEEK 2&quot;</span>, <span class="fl">20.2</span>, <span class="st">&quot;kg/m2&quot;</span>, <span class="st">&quot;2013-09-15&quot;</span>,</span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>  <span class="st">&quot;01-1302&quot;</span>, <span class="st">&quot;BMI&quot;</span>, <span class="st">&quot;WEEK 4&quot;</span>, <span class="fl">19.9</span>, <span class="st">&quot;kg/m2&quot;</span>, <span class="st">&quot;2013-09-24&quot;</span></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>)</span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>dm <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a>  <span class="sc">~</span>USUBJID, <span class="sc">~</span>AGE,</span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a>  <span class="st">&quot;01-1301&quot;</span>, <span class="dv">18</span></span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a>)</span></code></pre></div>
<div id="pitfall1" class="section level3">
<h3>1. Mistakenly passing something that isn’t an expression to an
argument</h3>
<p>When writing more complex <code>{admiral}</code> code it can be easy
to mistakenly pass the wrong input to an argument that expects an
expression. For example, the code below fails because
<code>my_expression</code> is not an expression - it is the name of an
object in the global environment containing an expression.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>my_expression <span class="ot">&lt;-</span> <span class="fu">expr</span>(VSTESTCD <span class="sc">==</span> <span class="st">&quot;WEIGHT&quot;</span> <span class="sc">&amp;</span> VISIT <span class="sc">==</span> <span class="st">&quot;SCREENING&quot;</span>)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="fu">derive_vars_merged</span>(</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>  dm,</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>  <span class="at">dataset_add =</span> <span class="fu">select</span>(vs, USUBJID, VSTESTCD, VISIT),</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>  <span class="at">by_vars =</span> <span class="fu">exprs</span>(USUBJID),</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>  <span class="at">filter_add =</span> my_expression</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>)</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="co">#&gt; Error in `derive_vars_merged()`:</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a><span class="co">#&gt; ! Argument `filter_add` must be a filter condition, but is a symbol</span></span></code></pre></div>
<p>To fix this code, we need to <a href="#unquoting">unquote</a>
<code>my_expression</code> so that the expression that it is holding is
passed correctly to <code>derive_vars_merged()</code>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="fu">derive_vars_merged</span>(</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>  dm,</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>  <span class="at">dataset_add =</span> <span class="fu">select</span>(vs, USUBJID, VSTESTCD, VISIT),</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>  <span class="at">by_vars =</span> <span class="fu">exprs</span>(USUBJID),</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>  <span class="at">filter_add =</span> <span class="sc">!!</span>my_expression</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>)</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 4</span></span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a><span class="co">#&gt;   USUBJID   AGE VSTESTCD VISIT    </span></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;    </span></span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a><span class="co">#&gt; 1 01-1301    18 WEIGHT   SCREENING</span></span></code></pre></div>
</div>
<div id="forgetting-that-expressions-must-be-evaluable-in-the-dataset" class="section level3">
<h3>2. Forgetting that expressions must be evaluable in the dataset</h3>
<p>In a similar vein to above, even if an actual expression <em>is</em>
passed as an argument, you must make sure that it can be evaluated
within the dataset of interest. This may seem trivial, but it is a
common pitfall because expressions delay evaluation of code and so can
delay the identification of issues. For instance, consider this
example:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>filter_vs_and_merge <span class="ot">&lt;-</span> <span class="cf">function</span>(my_expression) {</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>  <span class="fu">derive_vars_merged</span>(</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>    dm,</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>    <span class="at">dataset_add =</span> <span class="fu">select</span>(vs, USUBJID, VSTESTCD, VISIT),</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>    <span class="at">by_vars =</span> <span class="fu">exprs</span>(USUBJID),</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>    <span class="at">filter_add =</span> <span class="sc">!!</span>my_expression</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>  )</span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>}</span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a><span class="co"># This works</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a><span class="fu">filter_vs_and_merge</span>(<span class="fu">expr</span>(VSTESTCD <span class="sc">==</span> <span class="st">&quot;WEIGHT&quot;</span> <span class="sc">&amp;</span> VISIT <span class="sc">==</span> <span class="st">&quot;SCREENING&quot;</span>))</span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 4</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a><span class="co">#&gt;   USUBJID   AGE VSTESTCD VISIT    </span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;    </span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a><span class="co">#&gt; 1 01-1301    18 WEIGHT   SCREENING</span></span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a><span class="co"># This fails</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a><span class="fu">filter_vs_and_merge</span>(<span class="fu">expr</span>(VSTESTCD <span class="sc">==</span> <span class="st">&quot;WEIGHT&quot;</span> <span class="sc">&amp;</span> VISIT <span class="sc">==</span> <span class="st">&quot;SCREENING&quot;</span> <span class="sc">&amp;</span> VSTPT <span class="sc">==</span> <span class="st">&quot;PREDOSE&quot;</span>))</span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a><span class="co">#&gt; Error in `filter()`:</span></span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a><span class="co">#&gt; ℹ In argument: `VSTESTCD == &quot;WEIGHT&quot; &amp; VISIT == &quot;SCREENING&quot; &amp; VSTPT ==</span></span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a><span class="co">#&gt;   &quot;PREDOSE&quot;`.</span></span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a><span class="co">#&gt; Caused by error:</span></span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a><span class="co">#&gt; ! object &#39;VSTPT&#39; not found</span></span></code></pre></div>
<p>The second call fails because hidden within the expression is a
mention of <code>VSTPT</code>, which was dropped from <code>vs</code> in
<code>filter_vs_and_merge()</code>.</p>
</div>
</div>
</div>
<div id="see-also" class="section level1">
<h1>See also</h1>
<ul>
<li><a href="https://pharmaverse.github.io/admiraldev/articles/programming_strategy.html">Programming
Strategy</a></li>
</ul>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
